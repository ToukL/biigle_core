!function(e){var t={};function n(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(i,s,function(t){return e[t]}.bind(null,s));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=0)}({0:function(e,t,n){n("WfG0"),e.exports=n("zcrr")},WfG0:function(e,t,n){"use strict";n.r(t);function i(e,t,n,i,s,o,r,a){var l,c="function"==typeof e?e.options:e;if(t&&(c.render=t,c.staticRenderFns=n,c._compiled=!0),i&&(c.functional=!0),o&&(c._scopeId="data-v-"+o),r?(l=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),s&&s.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(r)},c._ssrRegister=l):s&&(l=a?function(){s.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:s),l)if(c.functional){c._injectStyles=l;var u=c.render;c.render=function(e,t){return l.call(t),u(e,t)}}else{var h=c.beforeCreate;c.beforeCreate=h?[].concat(h,l):[l]}return{exports:e,options:c}}var s=i({props:{entities:{type:Array,required:!0},filtering:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},data:function(){return{filterQuery:""}},computed:{classObject:function(){return{"entity-chooser-list--disabled":this.disabled}}},methods:{select:function(e){this.disabled||this.$emit("select",e)}},watch:{filterQuery:function(e){this.$emit("filter",e)}}},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"entity-chooser-list",class:e.classObject},[e.filtering?n("input",{directives:[{name:"model",rawName:"v-model",value:e.filterQuery,expression:"filterQuery"}],staticClass:"form-control entity-chooser-list-search",attrs:{type:"text",placeholder:"Filter...",disabled:e.disabled},domProps:{value:e.filterQuery},on:{input:function(t){t.target.composing||(e.filterQuery=t.target.value)}}}):e._e(),e._v(" "),n("ul",e._l(e.entities,(function(t){return n("li",{key:t.id,on:{click:function(n){return e.select(t)}}},[t.icon?n("i",{class:"fa fa-"+t.icon}):e._e(),e._v(" "),n("span",{domProps:{textContent:e._s(t.name)}}),e._v(" "),n("span",[n("br"),n("span",{staticClass:"text-muted",domProps:{textContent:e._s(t.description)}})])])})),0)])}),[],!1,null,null,null),o=i({components:{entityChooserList:s.exports},props:{entities:{type:Array,required:!0},disabled:{type:Boolean,default:!1}},data:function(){return{chosenIds:{},filterQuery:""}},computed:{unchosenEntities:function(){var e=this;return this.entities.filter((function(t){return!e.chosenIds[t.id]}))},unchosenFilteredEntities:function(){var e=this.filterQuery.trim();if(e){var t=e.toLowerCase().split(" ");return this.unchosenEntities.filter((function(e){var n=e.name.toLowerCase();return e.description&&(n+=" "+e.description.toLowerCase()),t.reduce((function(e,t){return e&&-1!==n.indexOf(t)}),!0)}))}return this.unchosenEntities},chosenEntities:function(){var e=this;return this.entities.filter((function(t){return e.chosenIds[t.id]}))},hasNoUnchosenEntities:function(){return 0===this.unchosenEntities.length},hasNoChosenEntities:function(){return 0===this.chosenEntities.length}},methods:{handleSelect:function(e){Vue.set(this.chosenIds,e.id,!0)},handleDeselect:function(e){this.chosenIds[e.id]=!1},chooseAll:function(){this.unchosenFilteredEntities.forEach(this.handleSelect)},chooseNone:function(){this.chosenEntities.forEach(this.handleDeselect)},handleFiltering:function(e){this.filterQuery=e}},watch:{chosenEntities:function(e){this.$emit("select",e)}}},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"entity-chooser"},[n("entity-chooser-list",{staticClass:"entity-chooser-list--left",attrs:{entities:e.unchosenFilteredEntities,filtering:!0,disabled:e.disabled},on:{select:e.handleSelect,filter:e.handleFiltering}}),e._v(" "),n("div",{staticClass:"entity-chooser-buttons"},[n("button",{staticClass:"btn btn-default btn-block",attrs:{disabled:e.disabled||e.hasNoUnchosenEntities,title:"Select all"},on:{click:e.chooseAll}},[e._v("all")]),e._v(" "),n("button",{staticClass:"btn btn-default btn-block",attrs:{disabled:e.disabled||e.hasNoChosenEntities,title:"Select none"},on:{click:e.chooseNone}},[e._v("none")])]),e._v(" "),n("entity-chooser-list",{staticClass:"entity-chooser-list--right",attrs:{entities:e.chosenEntities,disabled:e.disabled},on:{select:e.handleDeselect}})],1)}),[],!1,null,null,null).exports,r=biigle.$require("messages").handleErrorResponse,a=biigle.$require("api.labelTree"),l=biigle.$require("core.mixins.loader"),c=biigle.$require("api.projects"),u=biigle.$require("core.components.typeahead"),h=biigle.$require("api.users"),d={volumes:biigle.$require("api.volumes"),labelTrees:a,users:h},f=i({mixins:[l],components:{tabs:VueStrap.tabs,tab:VueStrap.tab,entityChooser:o},data:function(){return{exportApiUrl:null,allowedExports:[],entities:{volumes:[],labelTrees:[],users:[]},chosenEntities:{volumes:[],labelTrees:[],users:[]},currentTab:0,volumeIconMap:{}}},computed:{indexMap:function(){var e=this;return["volumes","labelTrees","users"].filter((function(t){return-1!==e.allowedExports.indexOf(t)}))},volumes:function(){var e=this;return this.entities.volumes.map((function(t){return t.description=t.projects.map((function(e){return e.name})).join(", "),t.icon=e.volumeIconMap[t.media_type_id],t}))},labelTrees:function(){return this.entities.labelTrees.map((function(e){return e.version&&(e.name=e.name+" @ "+e.version.name),e}))},users:function(){return this.entities.users.map((function(e){return e.name=e.firstname+" "+e.lastname,e.email&&(e.description=e.email),e}))},hasNoChosenVolumes:function(){return 0===this.chosenEntities.volumes.length},hasNoChosenLabelTrees:function(){return 0===this.chosenEntities.labelTrees.length},hasNoChosenUsers:function(){return 0===this.chosenEntities.users.length},volumeRequestUrl:function(){return this.exportApiUrl+"/volumes"+this.getQueryString("volumes")},labelTreeRequestUrl:function(){return this.exportApiUrl+"/label-trees"+this.getQueryString("labelTrees")},userRequestUrl:function(){return this.exportApiUrl+"/users"+this.getQueryString("users")}},methods:{handleSwitchedTab:function(e){this.currentTab=e},fetchEntities:function(e){var t=this;0===this.entities[e].length&&(this.startLoading(),d[e].get().then((function(n){return t.entities[e]=n.data}),r).finally(this.finishLoading))},handleChosenVolumes:function(e){this.chosenEntities.volumes=e},handleChosenLabelTrees:function(e){this.chosenEntities.labelTrees=e},handleChosenUsers:function(e){this.chosenEntities.users=e},getQueryString:function(e){var t=this.entities[e],n=this.chosenEntities[e];return t.length/2>n.length?"?only="+(n.map((function(e){return e.id})).join(",")||-1):t.length>n.length?"?except="+t.filter((function(e){return-1===n.indexOf(e)})).map((function(e){return e.id})).join(","):""}},watch:{currentTab:function(e){this.fetchEntities(this.indexMap[e])}},created:function(){this.exportApiUrl=biigle.$require("sync.exportApiUrl"),this.allowedExports=biigle.$require("sync.allowedExports");var e=biigle.$require("sync.mediaTypes");this.volumeIconMap[e.image]="image",this.volumeIconMap[e.video]="film",this.fetchEntities(this.indexMap[0])}},void 0,void 0,!1,null,null,null).exports,m=Vue.resource("api/v1/import{/token}"),p=i({mixins:[l],components:{entityChooser:o},data:function(){return{success:!1}},methods:{importSuccess:function(){this.success=!0}}},void 0,void 0,!1,null,null,null).exports,b=i({data:function(){return{success:!1,userCandidates:[],conflictingParents:[],chosenLabels:[],importLabels:[]}},computed:{userMap:function(){var e={};return this.userCandidates.forEach((function(t){t.name=t.firstname+" "+t.lastname,e[t.id]=t})),e},labelMap:function(){var e={};return this.importLabels.forEach((function(t){e[t.id]=t})),e},conflictingParentMap:function(){var e={};return this.conflictingParents.forEach((function(t){e[t.id]=t})),e},conflictingLabels:function(){var e=this;return this.chosenLabels.filter((function(e){return e.hasOwnProperty("conflicting_name")||e.hasOwnProperty("conflicting_parent_id")})).map((function(t){return t.hasOwnProperty("conflicting_parent_id")&&(t.parent=e.labelMap[t.parent_id],t.conflicting_parent=e.conflictingParentMap[t.conflicting_parent_id]),t}))},hasConflictingLabels:function(){return this.conflictingLabels.length>0},hasUnresolvedConflicts:function(){var e=this;return!this.conflictingLabels.reduce((function(t,n){return t&&e.isLabelConflictResolved(n)}),!0)},nameConflictResolutions:function(){var e=this,t={};return this.conflictingLabels.forEach((function(n){e.hasLabelConflictingName(n)&&(t[n.id]=n.conflicting_name_resolution)})),t},parentConflictResolutions:function(){var e=this,t={};return this.conflictingLabels.forEach((function(n){e.hasLabelConflictingParent(n)&&(t[n.id]=n.conflicting_parent_resolution)})),t},panelClass:function(){return{"panel-danger":this.hasUnresolvedConflicts}},panelBodyClass:function(){return{"text-danger":this.hasUnresolvedConflicts}}},methods:{importSuccess:function(){this.success=!0},hasLabelConflictingName:function(e){return e.hasOwnProperty("conflicting_name")},hasLabelConflictingParent:function(e){return e.hasOwnProperty("conflicting_parent_id")},isLabelConflictResolved:function(e){return(!this.hasLabelConflictingName(e)||e.conflicting_name_resolution)&&(!this.hasLabelConflictingParent(e)||e.conflicting_parent_resolution)},chooseAllImportInformation:function(){var e=this;this.conflictingLabels.forEach((function(t){e.chooseImportParent(t),e.chooseImportName(t)}))},chooseAllExistingInformation:function(){var e=this;this.conflictingLabels.forEach((function(t){e.chooseExistingParent(t),e.chooseExistingName(t)}))},chooseImportParent:function(e){this.hasLabelConflictingParent(e)&&Vue.set(e,"conflicting_parent_resolution","import")},chooseImportName:function(e){this.hasLabelConflictingName(e)&&Vue.set(e,"conflicting_name_resolution","import")},chooseExistingParent:function(e){this.hasLabelConflictingParent(e)&&Vue.set(e,"conflicting_parent_resolution","existing")},chooseExistingName:function(e){this.hasLabelConflictingName(e)&&Vue.set(e,"conflicting_name_resolution","existing")}},created:function(){this.importLabels=biigle.$require("sync.importLabels")}},void 0,void 0,!1,null,null,null).exports,g=i({mixins:[p,b],data:function(){return{importToken:null,adminRoleId:null,labelCandidates:[],conflictingParents:[],userCandidates:[],labelTreeCandidates:[],chosenLabelTrees:[],chosenLabels:[]}},computed:{chosenUsers:function(){var e=this,t=[];return this.chosenLabelTrees.forEach((function(n){n.members.forEach((function(n){n.role_id===e.adminRoleId&&-1===t.indexOf(n.id)&&t.push(n.id)}))})),t.filter((function(t){return e.userMap.hasOwnProperty(t)})).map((function(t){return e.userMap[t]}))},hasChosenUsers:function(){return this.chosenUsers.length>0},labels:function(){return this.labelCandidates.map((function(e){return e.description="Label tree: "+e.label_tree_name,e}))},hasNoChosenItems:function(){return 0===this.chosenLabelTrees.length&&0===this.chosenLabels.length},submitTitle:function(){return this.hasNoChosenItems?"Choose label trees or labels to import":this.hasUnresolvedConflicts?"Resolve the label conflicts":"Perform the import"},chosenLabelTreeIds:function(){return this.chosenLabelTrees.map((function(e){return e.id}))},chosenLabelIds:function(){return this.chosenLabels.map((function(e){return e.id}))}},methods:{handleChosenLabelTrees:function(e){this.chosenLabelTrees=e},handleChosenLabels:function(e){this.chosenLabels=e},performImport:function(){this.startLoading();var e={};this.chosenLabelTreeIds.length<this.labelTreeCandidates.length&&(e.only_label_trees=this.chosenLabelTreeIds),this.chosenLabelIds.length<this.labelCandidates.length&&(e.only_labels=this.chosenLabelIds),this.hasConflictingLabels&&(e.name_conflicts=this.nameConflictResolutions,e.parent_conflicts=this.parentConflictResolutions),m.update({token:this.importToken},e).then(this.importSuccess,r).finally(this.finishLoading)}},created:function(){this.importToken=biigle.$require("sync.importToken"),this.adminRoleId=biigle.$require("sync.adminRoleId"),this.labelCandidates=biigle.$require("sync.labelCandidates"),this.conflictingParents=biigle.$require("sync.conflictingParents"),this.userCandidates=biigle.$require("sync.userCandidates"),this.labelTreeCandidates=biigle.$require("sync.labelTreeCandidates").map((function(e){return e.version&&(e.name=e.name+" @ "+e.version.name),e}))}},void 0,void 0,!1,null,null,null).exports,v=i({mixins:[p],data:function(){return{importToken:null,importCandidates:[],chosenCandidates:[]}},computed:{users:function(){return this.importCandidates.map((function(e){return e.name=e.firstname+" "+e.lastname,e.email&&(e.description=e.email),e}))},hasNoChosenUsers:function(){return 0===this.chosenCandidates.length},chosenCandidateIds:function(){return this.chosenCandidates.map((function(e){return e.id}))}},methods:{handleChosenUsers:function(e){this.chosenCandidates=e},performImport:function(){this.startLoading();var e={};this.chosenCandidates.length<this.importCandidates.length&&(e.only=this.chosenCandidateIds),m.update({token:this.importToken},e).then(this.importSuccess,r).finally(this.finishLoading)}},created:function(){this.importToken=biigle.$require("sync.importToken"),this.importCandidates=biigle.$require("sync.importCandidates")}},void 0,void 0,!1,null,null,null).exports,C=i({mixins:[p,b],components:{typeahead:u},data:function(){return{importToken:null,adminRoleId:null,volumeCandidates:[],labelCandidates:[],conflictingParents:[],userCandidates:[],chosenVolumes:[],labelTreeCandidates:[],typeaheadTemplate:'<span v-text="item.name"></span><br><small v-text="item.description"></small>',availableProjects:[],targetProject:null}},computed:{volumes:function(){return this.volumeCandidates.map((function(e){return Vue.set(e,"new_url",e.url),"image"===e.media_type_name?e.icon="image":"video"===e.media_type_name&&(e.icon="film"),e}))},labelTreeMap:function(){var e={};return this.labelTreeCandidates.forEach((function(t){e[t.id]=t})),e},labelCandidateMap:function(){var e={};return this.labelCandidates.forEach((function(t){e[t.id]=t})),e},chosenUsers:function(){var e=this,t=[];return this.chosenVolumes.forEach((function(e){e.users.forEach((function(e){-1===t.indexOf(e)&&t.push(e)}))})),t.filter((function(t){return e.userMap.hasOwnProperty(t)})).map((function(t){return e.userMap[t]}))},hasChosenUsers:function(){return this.chosenUsers.length>0},chosenLabelTrees:function(){var e=this,t=[];return this.chosenVolumes.forEach((function(e){e.label_trees.forEach((function(e){-1===t.indexOf(e)&&t.push(e)}))})),t.filter((function(t){return e.labelTreeMap.hasOwnProperty(t)})).map((function(t){return e.labelTreeMap[t]}))},hasChosenLabelTrees:function(){return this.chosenLabelTrees.length>0},chosenLabelTreeAdmins:function(){var e=this,t=[];return this.chosenLabelTrees.forEach((function(n){n.members.forEach((function(n){n.role_id===e.adminRoleId&&-1===t.indexOf(n.id)&&t.push(n.id)}))})),t.filter((function(t){return e.userMap.hasOwnProperty(t)})).map((function(t){return e.userMap[t]}))},hasChosenLabelTreeAdmins:function(){return this.chosenLabelTreeAdmins.length>0},chosenLabelsOverride:function(){var e=this,t=[];return this.chosenVolumes.forEach((function(e){e.labels.forEach((function(e){-1===t.indexOf(e)&&t.push(e)}))})),t.filter((function(t){return e.labelCandidateMap.hasOwnProperty(t)})).map((function(t){return e.labelCandidateMap[t]}))},hasChosenLabels:function(){return this.chosenLabels.length>0},hasNoChosenItems:function(){return 0===this.chosenVolumes.length},submitTitle:function(){return this.hasNoChosenItems?"Choose volumes to import":this.hasUnresolvedConflicts?"Resolve the label conflicts":this.hasNoSelectedProject?"Select a target project":"Perform the import"},hasNoSelectedProject:function(){return null===this.targetProject},cantDoImport:function(){return this.loading||this.hasNoChosenItems||this.hasUnresolvedConflicts||this.hasNoSelectedProject},chosenVolumeIds:function(){return this.chosenVolumes.map((function(e){return e.id}))},newVolumeUrls:function(){var e={};return this.chosenVolumes.forEach((function(t){t.url!==t.new_url&&(e[t.id]=t.new_url)})),e},hasNewVolumeUrls:function(){return this.chosenVolumes.reduce((function(e,t){return e||t.url!==t.new_url}),!1)}},methods:{selectTargetProject:function(e){this.targetProject=e},handleChosenVolumes:function(e){this.chosenVolumes=e},performImport:function(){this.startLoading();var e={project_id:this.targetProject.id};this.chosenVolumeIds.length<this.volumes.length&&(e.only=this.chosenVolumeIds),this.hasNewVolumeUrls&&(e.new_urls=this.newVolumeUrls),this.hasConflictingLabels&&(e.name_conflicts=this.nameConflictResolutions,e.parent_conflicts=this.parentConflictResolutions),m.update({token:this.importToken},e).then(this.importSuccess,r).finally(this.finishLoading)}},watch:{hasNoChosenItems:function(e){var t=this;0!==this.availableProjects.length||e||c.query().then((function(e){t.availableProjects=e.body}),r)},chosenLabelsOverride:function(e){this.chosenLabels=e}},created:function(){this.importToken=biigle.$require("sync.importToken"),this.adminRoleId=biigle.$require("sync.adminRoleId"),this.volumeCandidates=biigle.$require("sync.volumeCandidates"),this.labelCandidates=biigle.$require("sync.labelCandidates"),this.conflictingParents=biigle.$require("sync.conflictingParents"),this.userCandidates=biigle.$require("sync.userCandidates"),this.labelTreeCandidates=biigle.$require("sync.labelTreeCandidates").map((function(e){return e.version&&(e.name=e.name+" @ "+e.version.name),e}))}},void 0,void 0,!1,null,null,null).exports;biigle.$mount("export-container",f),biigle.$mount("label-tree-import-container",g),biigle.$mount("user-import-container",v),biigle.$mount("volume-import-container",C)},zcrr:function(e,t){}});