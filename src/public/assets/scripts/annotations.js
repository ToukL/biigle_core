angular.module("biigle.annotations").controller("ExportAreaSettingsController",["$scope","exportArea","settings",function(e,t,n){"use strict";var o="export_area_opacity";n.setDefaultSettings(o,"1"),e[o]=n.getPermanentSettings(o),e.edit=function(){e.isShown()||(e[o]="1"),t.toggleEdit()},e.isEditing=t.isEditing,e.isShown=function(){return"0"!==e[o]},e.delete=function(){t.hasArea()&&confirm("Do you really want to delete the export area?")&&t.deleteArea()},e.$on("image.shown",t.updateHeight),e.$watch(o,function(e){n.setPermanentSettings(o,e),t.setOpacity(e)})}]),angular.module("biigle.annotations").factory("ExportArea",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/volumes/:volume_id/export-area")}]),angular.module("biigle.annotations").service("exportArea",["map","styles","ExportArea","VOLUME_ID","EXPORT_AREA","msg",function(e,t,n,o,r,i){"use strict";var a,l,s=[new ol.style.Style({stroke:new ol.style.Stroke({color:t.colors.white,width:4}),image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:"#666666"}),stroke:new ol.style.Stroke({color:t.colors.white,width:2,lineDash:[2]})})}),new ol.style.Style({stroke:new ol.style.Stroke({color:"#666666",width:1,lineDash:[2]})})],u=!1,c=new ol.Collection,d=new ol.source.Vector({features:c}),g=new ol.layer.Vector({source:d,style:s,zIndex:4,updateWhileAnimating:!0,updateWhileInteracting:!0});e.addLayer(g);var f=new ol.interaction.Draw({source:d,type:"Rectangle",style:s,minPoints:2,maxPoints:2,geometryFunction:function(e,t){e=e[0],e.length>1&&(e=[e[0],[e[0][0],e[1][1]],e[1],[e[1][0],e[0][1]]]);var n=t;return n?n.setCoordinates([e]):n=new ol.geom.Rectangle([e]),n}});f.on("drawend",function(e){l&&d.removeFeature(l),y(e.feature).then(function(){l=e.feature}).catch(function(){d.removeFeature(e.feature),l&&d.addFeature(l)})});var h=new ol.interaction.Modify({features:c,style:s,deleteCondition:ol.events.condition.never}),m=function(){l&&(d.removeFeature(l),n.delete({volume_id:o},function(){l=void 0},function(e){d.addFeature(l),i.responseError(e)}))},y=function(e){var t=p(e.getGeometry().getCoordinates());return n.save({volume_id:o},{coordinates:t},function(){r=t},i.responseError).$promise};h.on("modifyend",function(){l&&y(l)});var w=function(e){return[[e[0],a-e[1]],[e[0],a-e[3]],[e[2],a-e[3]],[e[2],a-e[1]]]},p=function(e){return e=e[0],e=[e[0][0],a-e[0][1],e[2][0],a-e[2][1]],e.map(Math.round)},v=function(){if(r&&4===r.length){var e=new ol.geom.Rectangle([w(r)]);l?l.setGeometry(e):(l=new ol.Feature({geometry:e}),d.addFeature(l))}};this.updateHeight=function(e,t){a!==t.height&&(a=t.height,v())},this.toggleEdit=function(){u?(e.removeInteraction(f),e.removeInteraction(h)):(e.addInteraction(f),e.addInteraction(h)),u=!u},this.isEditing=function(){return u},this.setOpacity=function(e){g.setOpacity(e)},this.deleteArea=m,this.hasArea=function(){return!!l}}]);