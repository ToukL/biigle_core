angular.module("dias.annotations").controller("ExportAreaSettingsController",["$scope","exportArea","settings",function(e,t,n){"use strict";var o="export_area_opacity";n.setDefaultSettings(o,"1"),e[o]=n.getPermanentSettings(o),e.edit=function(){e.isShown()||(e[o]="1"),t.toggleEdit()},e.isEditing=t.isEditing,e.isShown=function(){return"0"!==e[o]},e["delete"]=function(){t.hasArea()&&confirm("Do you really want to delete the export area?")&&t.deleteArea()},e.$on("image.shown",t.updateHeight),e.$watch(o,function(e){n.setPermanentSettings(o,e),t.setOpacity(e)})}]),angular.module("dias.annotations").service("exportArea",["map","styles","ExportArea","TRANSECT_ID","EXPORT_AREA","msg",function(e,t,n,o,r,i){"use strict";var a,s,l=[new ol.style.Style({stroke:new ol.style.Stroke({color:t.colors.white,width:4}),image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:"#666666"}),stroke:new ol.style.Stroke({color:t.colors.white,width:2,lineDash:[2]})})}),new ol.style.Style({stroke:new ol.style.Stroke({color:"#666666",width:1,lineDash:[2]})})],c=!1,u=new ol.Collection,d=new ol.source.Vector({features:u}),f=new ol.layer.Vector({source:d,style:l,zIndex:4,updateWhileAnimating:!0,updateWhileInteracting:!0});e.addLayer(f);var g=new ol.interaction.Draw({source:d,type:"Rectangle",style:l,minPoints:2,maxPoints:2,geometryFunction:function(e,t){e=e[0],e.length>1&&(e=[e[0],[e[0][0],e[1][1]],e[1],[e[1][0],e[0][1]]]);var n=t;return n?n.setCoordinates([e]):n=new ol.geom.Rectangle([e]),n}});g.on("drawend",function(e){s&&d.removeFeature(s),m(e.feature).then(function(){s=e.feature})["catch"](function(){d.removeFeature(e.feature),s&&d.addFeature(s)})});var h=new ol.interaction.Modify({features:u,style:l,deleteCondition:ol.events.condition.never}),y=function(){s&&(d.removeFeature(s),n["delete"]({transect_id:o},function(){s=void 0},function(e){d.addFeature(s),i.responseError(e)}))},m=function(e){var t=p(e.getGeometry().getCoordinates());return n.save({transect_id:o},{coordinates:t},function(){r=t},i.responseError).$promise};h.on("modifyend",function(){s&&m(s)});var w=function(e){return[[e[0],a-e[1]],[e[0],a-e[3]],[e[2],a-e[3]],[e[2],a-e[1]]]},p=function(e){return e=e[0],e=[e[0][0],a-e[0][1],e[2][0],a-e[2][1]],e.map(Math.round)},v=function(){if(r&&4===r.length){var e=new ol.geom.Rectangle([w(r)]);s?s.setGeometry(e):(s=new ol.Feature({geometry:e}),d.addFeature(s))}};this.updateHeight=function(e,t){a!==t.height&&(a=t.height,v())},this.toggleEdit=function(){c?(e.removeInteraction(g),e.removeInteraction(h)):(e.addInteraction(g),e.addInteraction(h)),c=!c},this.isEditing=function(){return c},this.setOpacity=function(e){f.setOpacity(e)},this.deleteArea=y,this.hasArea=function(){return!!s}}]),angular.module("dias.annotations").factory("ExportArea",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/transects/:transect_id/export-area")}]);