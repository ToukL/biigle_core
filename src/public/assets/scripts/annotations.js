angular.module("dias.annotations").controller("ExportAreaSettingsController",["$scope","exportArea",function(e,t){"use strict";e.setDefaultSettings("export_area_opacity","1"),e.edit=function(){e.isShown()||(e.settings.export_area_opacity="1"),t.toggleEdit()},e.isEditing=t.isEditing,e.isShown=function(){return"0"!==e.settings.export_area_opacity},e["delete"]=function(){t.hasArea()&&confirm("Do you really want to delete the export area?")&&t.deleteArea()},e.$on("image.shown",t.updateHeight),e.$watch("settings.export_area_opacity",t.setOpacity)}]),angular.module("dias.annotations").factory("ExportArea",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/transects/:transect_id/export-area")}]),angular.module("dias.annotations").service("exportArea",["map","styles","ExportArea","TRANSECT_ID","EXPORT_AREA",function(e,t,o,n,i){"use strict";var r,a,s=[new ol.style.Style({stroke:new ol.style.Stroke({color:t.colors.white,width:4}),image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:"#666666"}),stroke:new ol.style.Stroke({color:t.colors.white,width:2,lineDash:[2]})})}),new ol.style.Style({stroke:new ol.style.Stroke({color:"#666666",width:1,lineDash:[2]})})],l=!1,c=new ol.Collection,u=new ol.source.Vector({features:c}),d=new ol.layer.Vector({source:u,style:s,zIndex:4,updateWhileAnimating:!0,updateWhileInteracting:!0});e.addLayer(d);var g=new ol.interaction.Draw({source:u,type:"Rectangle",style:s,minPoints:2,maxPoints:2,geometryFunction:function(e,t){e=e[0],e.length>1&&(e=[e[0],[e[0][0],e[1][1]],e[1],[e[1][0],e[0][1]]]);var o=t;return o?o.setCoordinates([e]):o=new ol.geom.Rectangle([e]),o}});g.on("drawend",function(e){h(),a=e.feature,p()});var y=new ol.interaction.Modify({features:c,style:s,deleteCondition:ol.events.condition.never}),h=function(){void 0!==a&&(u.removeFeature(a),a=void 0)},f=function(){h(),o["delete"]({transect_id:n})},p=function(){a&&(coordinates=m(a.getGeometry().getCoordinates()),o.save({transect_id:n},{coordinates:coordinates},function(){i=coordinates}))};y.on("modifyend",p);var w=function(e){return[[e[0],r-e[1]],[e[0],r-e[3]],[e[2],r-e[3]],[e[2],r-e[1]]]},m=function(e){return e=e[0],e=[e[0][0],r-e[0][1],e[2][0],r-e[2][1]],e.map(Math.round)},v=function(){if(i&&4===i.length){var e=new ol.geom.Rectangle([w(i)]);a?a.setGeometry(e):(a=new ol.Feature({geometry:e}),u.addFeature(a))}};this.updateHeight=function(e,t){r!==t.height&&(r=t.height,v())},this.toggleEdit=function(){l?(e.removeInteraction(g),e.removeInteraction(y)):(e.addInteraction(g),e.addInteraction(y)),l=!l},this.isEditing=function(){return l},this.setOpacity=function(e){d.setOpacity(e)},this.deleteArea=f,this.hasArea=function(){return!!a}}]);